{% extends "admin-dashboard/base.html" %}
{% load static %}






{% block title %}{{ page_title }}{% endblock %}

{% block extrastyle %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<!-- 添加 Naive UI 的樣式 -->
<link href="https://unpkg.com/naive-ui@2.34.4/dist/index.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
<style>
    .page-container {
        max-width: 80rem;
        margin: 0 auto;
        padding: 0 1.5rem;
    }

    .custom-card {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        background-color: white;
        backdrop-filter: blur(8px);
    }

    .page-header {
        background: linear-gradient(to right, #3b82f6, #2563eb);
        color: white;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .custom-table {
        border-radius: 0.5rem;
        overflow: hidden;
        background-color: white;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    .table-header {
        background: linear-gradient(to right, #f9fafb, #f3f4f6);
        border-bottom: 1px solid #e5e7eb;
    }

    .table-header th {
        padding: 1rem 1.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: #4b5563;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .table-row {
        transition: all 0.2s;
        border-bottom: 1px solid #f3f4f6;
    }

    .table-row:hover {
        background-color: #eff6ff;
    }

    .table-cell {
        padding: 1.5rem;
        font-size: 0.875rem;
        white-space: nowrap;
        vertical-align: middle;
    }

    .table-cell-primary {
        font-weight: 500;
        color: #111827;
    }

    .table-cell-secondary {
        color: #4b5563;
    }

    .table-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        border-radius: 9999px;
        background-color: #dbeafe;
        color: #3b82f6;
        margin-right: 0.75rem;
    }

    .table-actions {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 0.5rem;
    }

    .action-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.375rem 0.75rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s;
    }

    .action-button-edit {
        background-color: #3b82f6;
        color: white;
    }

    .action-button-edit:hover {
        background-color: #2563eb;
    }

    .action-button-delete {
        background-color: #ef4444;
        color: white;
    }

    .action-button-delete:hover {
        background-color: #dc2626;
    }

    .date-badge,
    .location-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.125rem 0.625rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    .date-badge {
        background-color: #dbeafe;
        color: #1e40af;
    }

    .location-badge {
        background-color: #dcfce7;
        color: #166534;
    }

    .btn-primary {
        background-color: #3b82f6;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        transition: all 0.3s;
        transform: translateY(0);
    }

    .btn-primary:hover {
        background-color: #2563eb;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .btn-danger {
        background-color: #ef4444;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        transition: all 0.3s;
        transform: translateY(0);
    }

    .btn-danger:hover {
        background-color: #dc2626;
        transform: translateY(-2px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .loading-spinner {
        animation: spin 1s linear infinite;
        height: 2rem;
        width: 2rem;
        border: 4px solid #3b82f6;
        border-top-color: transparent;
        border-radius: 50%;
        margin: 2rem auto;
    }

    .status-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 500;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="app">
    <!-- Vue 應用將在這裡渲染 -->
</div>

<!-- 引入相關依賴 -->
<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://unpkg.com/naive-ui@2.34.4/dist/index.js"></script>

<script>
    const { createApp, ref, onMounted, h, watch } = Vue;
    const { NButton, NSpace, NCard, NDataTable, NIcon, NLayout, NLayoutHeader, NLayoutContent, NGrid, NGridItem } = naive;

    const app = createApp({
        components: {
            NButton, NSpace, NCard, NDataTable, NIcon, NLayout, NLayoutHeader, NLayoutContent, NGrid, NGridItem
        },
        setup() {
            const activities = ref([]);
            const loading = ref(false);
            const error = ref(null);
            const pagination = ref({
                page: 1,
                pageSize: 10,
                showSizePicker: true,
                pageSizes: [10, 50, 100, 500, 1000],
                onChange: (page) => {
                    pagination.value.page = page;
                },
                onUpdatePageSize: (pageSize) => {
                    pagination.value.pageSize = pageSize;
                    pagination.value.page = 1;
                }
            });

            const handleCreateClick = () => {
                try {
                    window.location.href = '/admin-dashboard/entertainment/activities/create/';
                } catch (error) {
                    console.error('Navigation error:', error);
                }
            };

            // 修改獲取活動列表函數以支援分頁
            const fetchActivities = async () => {
                try {
                    loading.value = true;
                    const response = await axios.get('/admin-dashboard/entertainment/activities/list/', {
                        params: {
                            page: pagination.value.page,
                            page_size: pagination.value.pageSize
                        }
                    });
                    activities.value = response.data.data;
                    pagination.value.itemCount = response.data.total; // 假設後端返回總數
                } catch (err) {
                    error.value = '獲取數據失敗';
                    console.error('Error:', err);
                } finally {
                    loading.value = false;
                }
            };

            // 監聽分頁變化
            watch(() => [pagination.value.page, pagination.value.pageSize], () => {
                fetchActivities();
            });

            // 刪除活動
            const deleteActivity = async (id) => {
                if (confirm('確定要刪除此活動嗎？')) {
                    try {
                        const response = await axios.delete(
                            `/admin-dashboard/entertainment/activities/${id}/delete/`
                        );
                        if (response.data.status === 'success') {
                            await fetchActivities(); // 重新加載列表
                        }
                    } catch (err) {
                        error.value = '刪除失敗';
                        console.error('Error:', err);
                    }
                }
            };

            // 在組件掛載時獲取數據
            onMounted(() => {
                fetchActivities();
            });

            const columns = [
                {
                    title: 'ID',
                    key: 'id',
                    width: 50,
                    sorter: 'default',
                    defaultSortOrder: 'ascend',
                    render(row) {
                        return h('span', { class: 'text-gray-500 font-mono' }, `#${row.id}`);
                    }
                },
                {
                    title: '活動名稱',
                    key: 'activity_name',
                    width: 300,
                    sorter: 'default',
                    render(row) {
                        return h('span', { class: 'font-medium' }, row.activity_name);
                    }
                },
                {
                    title: '活動地點',
                    key: 'location',
                    width: 150,
                    sorter: 'default',
                    render(row) {
                        return h('div', { class: 'text-gray-600' }, [
                            h('i', { class: 'fas fa-map-marker-alt mr-2' }),
                            row.location || '未指定地點'
                        ]);
                    }
                },
                {
                    title: '活動日期',
                    key: 'date',
                    width: 150,
                    sorter: (row1, row2) => new Date(row1.start_date) - new Date(row2.start_date),
                    render(row) {
                        return h('div', { class: 'text-gray-600' }, [
                            h('i', { class: 'far fa-calendar-alt mr-2' }),
                            `${row.start_date || ''} ~ ${row.end_date || ''}`
                        ]);
                    }
                },
                {
                    title: '票價',
                    key: 'ticket_price',
                    width: 80,
                    sorter: 'default',
                    render(row) {
                        return h('div', { class: 'text-gray-600' }, [
                            h('i', { class: 'fas fa-ticket-alt mr-2' }),
                            row.ticket_price ? `NT$ ${row.ticket_price}` : '免費'
                        ]);
                    }
                },
                {
                    title: '操作',
                    key: 'actions',
                    width: 100,
                    render(row) {
                        return h(NSpace, null, {
                            default: () => [
                                h(NButton, {
                                    type: 'primary',
                                    size: 'small',
                                    onClick: () => window.location.href = `/admin-dashboard/entertainment/activities/${row.id}/`
                                }, { default: () => '編輯' }),
                                h(NButton, {
                                    type: 'error',
                                    size: 'small',
                                    onClick: () => deleteActivity(row.id)
                                }, { default: () => '刪除' })
                            ]
                        });
                    }
                }
            ];

            return {
                activities,
                loading,
                error,
                deleteActivity,
                columns,
                pagination,
                handleCreateClick,
            };
        },
        template: `
            <n-layout>
                <n-layout-header style="padding: 24px">
                    <n-card>
                        <n-grid :cols="2">
                            <n-grid-item>
                                <h1 style="font-size: 24px; margin: 0">{{ page_title }}</h1>
                                <p style="margin: 8px 0 0; color: #666">{{ page_description }}</p>
                            </n-grid-item>
                            <n-grid-item style="text-align: right">
                                <n-button type="primary" @click="handleCreateClick">
                                    <template #icon><i class="fas fa-plus"></i></template>
                                    新增活動
                                </n-button>
                            </n-grid-item>
                        </n-grid>
                    </n-card>
                </n-layout-header>
                <n-layout-content style="padding: 24px">
                    <n-card v-if="error" type="error" style="margin-bottom: 16px">
                        {{ error }}
                    </n-card>
                    <n-card>
                        <n-data-table
                            :columns="columns"
                            :data="activities"
                            :loading="loading"
                            :bordered="false"
                            :single-line="false"
                            :pagination="pagination"
                            style="margin-top: 16px"
                            :default-sort="{ columnKey: 'id', order: 'ascend' }"
                        />
                    </n-card>
                </n-layout-content>
            </n-layout>
        `    });

    app.config.compilerOptions.delimiters = ['[[', ']]'];
    app.mount('#app');
</script>
{% endblock %}