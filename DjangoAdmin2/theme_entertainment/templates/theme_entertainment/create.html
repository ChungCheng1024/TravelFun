{% extends "admin-dashboard/base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extracss %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://unpkg.com/naive-ui@2.34.4/dist/index.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="app">
    <!-- Vue 應用將在這裡渲染 -->
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/naive-ui@2.34.4/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp, ref } = Vue;
    const { NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker, NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider, useMessage } = naive;

    const app = createApp({
        components: {
            NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker, NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider
        },
        setup() {
            const handleBack = () => {
                window.location.href = '/admin-dashboard/entertainment/activities/';
            };

            const message = ref(null);
            const handleMessage = () => {
                message.value = useMessage();
            };
            const formRef = ref(null);
            const formValue = ref({
                activity_name: '',
                description: '',
                location: '',
                event_date: null,
                event_time: null,
                ticket_price: '',
                activity_type: null,
                image: null
            });

            const activityTypes = [
                { label: '展覽', value: '展覽' },
                { label: '表演', value: '表演' },
                { label: '音樂會', value: '音樂會' },
                { label: '戲劇', value: '戲劇' },
                { label: '其他', value: '其他' }
            ];

            const rules = {
                activity_name: {
                    required: true,
                    message: '請輸入活動名稱',
                    trigger: 'blur'
                },
                description: {
                    required: true,
                    message: '請輸入活動描述',
                    trigger: 'blur'
                },
                location: {
                    required: true,
                    message: '請輸入活動地點',
                    trigger: 'blur'
                },
                event_date: {
                    required: true,
                    message: '請選擇活動日期',
                    trigger: 'blur'
                },
                activity_type: {
                    required: true,
                    message: '請選擇活動類型',
                    trigger: 'change'
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    await formRef.value?.validate();

                    const formData = new FormData();
                    Object.keys(formValue.value).forEach(key => {
                        if (formValue.value[key] !== null) {
                            formData.append(key, formValue.value[key]);
                        }
                    });

                    const response = await axios.post('/admin-dashboard/entertainment/activities/create/', formData, {
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'multipart/form-data'
                        }
                    });

                    if (response.data.status === 'success') {
                        message.value.success('活動建立成功');
                        setTimeout(() => {
                            window.location.href = '/admin-dashboard/entertainment/activities/';
                        }, 1500);
                    }
                } catch (error) {
                    message.value.error('表單驗證失敗或提交出錯');
                    console.error(error);
                }
            };

            return {
                formRef,
                formValue,
                activityTypes,
                rules,
                handleSubmit,
                handleMessage,
                handleBack
            };
        },
        template: `
        <n-message-provider>
            <n-layout class="p-6" @mounted="handleMessage">
                <n-card class="mb-6">
                    <n-grid :cols="2">
                        <n-grid-item>
                            <h1 class="text-2xl font-bold mb-2">{{ page_title }}</h1>
                            <p class="text-gray-600">{{ page_description }}</p>
                        </n-grid-item>
                        <n-grid-item class="text-right">
                            <n-button type="default" @click="handleBack">
                                <template #icon><i class="fas fa-arrow-left"></i></template>
                                返回列表
                            </n-button>
                        </n-grid-item>
                    </n-grid>
                </n-card>

                <n-grid :x-gap="12" :cols="2">
                    <n-grid-item span="1">
                        <n-card title="活動基本資訊" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="活動名稱" path="activity_name">
                                    <n-input v-model:value="formValue.activity_name" placeholder="請輸入活動名稱"/>
                                </n-form-item>

                                <n-form-item label="活動描述" path="description">
                                    <n-input
                                        v-model:value="formValue.description"
                                        type="textarea"
                                        placeholder="請輸入活動描述"
                                        :rows="4"
                                    />
                                </n-form-item>

                                <n-form-item label="活動地點" path="location">
                                    <n-input v-model:value="formValue.location" placeholder="請輸入活動地點"/>
                                </n-form-item>

                                <n-grid :cols="2" :x-gap="12">
                                    <n-grid-item>
                                        <n-form-item label="活動日期" path="event_date">
                                            <n-date-picker v-model:value="formValue.event_date" type="date" clearable/>
                                        </n-form-item>
                                    </n-grid-item>
                                    <n-grid-item>
                                        <n-form-item label="活動時間" path="event_time">
                                            <n-time-picker
                                                v-model:value="formValue.event_time"
                                                clearable
                                                format="HH:mm"
                                                :minutes-step="5"
                                                :minutes-options="[
                                                    '00', '05', '10', '15', '20', '25',
                                                    '30', '35', '40', '45', '50', '55'
                                                ]"
                                                :use-12-hours="false"
                                                placement="top-start"
                                                :is-hours-disabled="(hour) => false"
                                                :is-minutes-disabled="(minute) => minute % 5 !== 0"
                                                :actions="null"
                                            />
                                        </n-form-item>
                                    </n-grid-item>
                                </n-grid>
                            </n-form>
                        </n-card>
                    </n-grid-item>

                    <n-grid-item span="1">
                        <n-card title="活動詳細設定" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="票價資訊">
                                    <n-input v-model:value="formValue.ticket_price" placeholder="請輸入票價資訊（若為免費活動可不填）"/>
                                </n-form-item>

                                <n-form-item label="活動類型" path="activity_type">
                                    <n-select
                                        v-model:value="formValue.activity_type"
                                        :options="activityTypes"
                                        placeholder="請選擇活動類型"
                                    />
                                </n-form-item>

                                <n-form-item label="活動圖片">
                                    <n-upload
                                        accept="image/*"
                                        :max="1"
                                        @change="handleImageUpload"
                                    >
                                        <n-button>上傳圖片</n-button>
                                    </n-upload>
                                    <p class="text-sm text-gray-500 mt-2">建議尺寸: 1200x630 像素，檔案大小不超過 2MB</p>
                                </n-form-item>

                                <div class="flex justify-between mt-6">
                                    <n-button type="primary" @click="handleSubmit" size="large">
                                        <template #icon><i class="fas fa-save"></i></template>
                                        建立活動
                                    </n-button>
                                    <n-button @click="formRef?.restoreValidation()" size="large">
                                        <template #icon><i class="fas fa-undo"></i></template>
                                        重置
                                    </n-button>
                                </div>
                            </n-form>
                        </n-card>
                    </n-grid-item>
                </n-grid>
            </n-layout>
        </n-message-provider>
    `
    });

    app.mount('#app');
</script>
{% endblock %}