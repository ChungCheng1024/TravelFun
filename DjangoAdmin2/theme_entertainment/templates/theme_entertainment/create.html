{% extends "admin-dashboard/base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extracss %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link href="https://unpkg.com/naive-ui@2.34.4/dist/index.css" rel="stylesheet">
<script src="https://kit.fontawesome.com/your-kit-code.js" crossorigin="anonymous"></script>

<style>
    /* 表單樣式 */
    .n-form-item-label {
        font-weight: 500;
    }

    .n-input,
    .n-select,
    .n-date-picker {
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    }

    .n-button {
        transition: all 0.2s ease;
    }

    .n-button:hover {
        transform: translateY(-1px);
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF令牌 -->
{% csrf_token %}

<div id="app" class="wrapper wrapper-content animated fadeInRight">
    <!-- Vue 應用將在這裡渲染 -->
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://unpkg.com/naive-ui@2.34.4/dist/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    const { createApp, ref, computed } = Vue;
    const {
        NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker,
        NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider,
        useMessage
    } = naive;

    const app = createApp({
        components: {
            NLayout, NCard, NForm, NFormItem, NInput, NDatePicker, NTimePicker,
            NSelect, NUpload, NButton, NGrid, NGridItem, NSpace, NMessageProvider
        },
        setup() {
            // 表單與訊息相關參考
            const formRef = ref(null);
            const message = ref(null);

            // 訊息系統初始化
            const initMessageSystem = () => {
                if (message.value === null) {
                    message.value = useMessage();
                    console.log('訊息系統初始化完成');
                }
                return message.value;
            };

            // 掛載後立即初始化訊息系統
            const initComponent = () => {
                setTimeout(initMessageSystem, 100);
            };

            // 返回列表頁面
            const handleBack = () => {
                window.location.href = '/admin-dashboard/entertainment/activities/';
            };

            // 表單資料
            const formValue = ref({
                activity_name: '',
                description: '',
                location: '',
                address: '',
                organizer: '',
                source_url: '',
                date_range: null,
                start_time: null,
                end_time: null,
                ticket_price: '',
                activity_type: null,
                image: null,
                imageFile: null
            });

            // 活動類型選項
            const activityTypes = [
                { label: '展覽', value: '展覽' },
                { label: '表演', value: '表演' },
                { label: '音樂會', value: '音樂會' },
                { label: '戲劇', value: '戲劇' },
                { label: '其他', value: '其他' }
            ];

            // 表單驗證規則
            const rules = {
                activity_name: {
                    required: true,
                    message: '請輸入活動名稱',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (value && value.length > 30) {
                            return new Error('活動名稱不能超過30字');
                        }
                        return true;
                    }
                },
                description: {
                    required: true,
                    message: '請輸入活動介紹',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (value && value.length > 500) {
                            return new Error('活動介紹不能超過500字');
                        }
                        return true;
                    }
                },
                location: {
                    required: true,
                    message: '請輸入活動地點',
                    trigger: 'blur'
                },
                date_range: {
                    required: true,
                    message: '請選擇活動日期範圍',
                    trigger: 'blur',
                    validator: (rule, value) => {
                        if (!value || !value[0] || !value[1]) {
                            return new Error('請選擇完整的日期範圍');
                        }
                        return true;
                    }
                },
                activity_type: {
                    required: true,
                    message: '請選擇活動類型',
                    trigger: 'change'
                },
                address: {
                    required: true,
                    message: '請輸入活動詳細地址',
                    trigger: 'blur'
                },
                organizer: {
                    required: true,
                    message: '請輸入主辦單位名稱',
                    trigger: 'blur'
                }
            };

            // ===== 圖片處理 =====
            // 處理圖片上傳
            const handleImageUpload = (options) => {
                const { file } = options;
                if (file.file) {
                    // 保存檔案物件
                    formValue.value.imageFile = file.file;

                    // 建立預覽用的 base64
                    const reader = new FileReader();
                    reader.readAsDataURL(file.file);
                    reader.onload = () => {
                        formValue.value.image = reader.result;
                    };
                }
            };

            // 圖片預覽狀態
            const showImagePreview = computed(() => Boolean(formValue.value.image));

            // ===== 表單處理 =====
            // 日期格式化輔助函數
            const formatDate = (date) => {
                if (!date) return null;
                const d = new Date(date);
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };

            // UUID 生成函數
            const generateUUID = () => {
                const hexDigits = "0123456789abcdef";
                let uuid = "";
                for (let i = 0; i < 32; i++) {
                    // UUID v4 版本的特定位置需要特定值
                    if (i === 12) {
                        uuid += "4"; // 版本4
                    } else if (i === 16) {
                        uuid += hexDigits[(Math.floor(Math.random() * 16) & 0x3) | 0x8]; // 變體
                    } else {
                        uuid += hexDigits[Math.floor(Math.random() * 16)];
                    }
                }
                return uuid; // 32位字符，不含連字符
            };

            // 獲取 CSRF 令牌
            const getCsrfToken = () => {
                let csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
                if (!csrfToken) {
                    const csrfCookie = document.cookie
                        .split('; ')
                        .find(row => row.startsWith('csrftoken='));
                    if (csrfCookie) {
                        csrfToken = csrfCookie.split('=')[1];
                    }
                }
                console.log('使用的CSRF令牌:', csrfToken);
                return csrfToken;
            };

            // 顯示操作結果訊息
            const showResultMessage = (success, data) => {
                // 確保訊息系統已初始化
                const msgInstance = initMessageSystem();
                const activityName = data.activity_name || '新活動';
                const redirectUrl = data.redirect_url || `${window.location.origin}/admin-dashboard/entertainment/activities/`;

                // 成功訊息內容
                const successTitle = `活動「${activityName}」建立成功！`;
                const successContent = `活動ID: ${data.id}\n建立時間: ${data.created_at}`;

                if (success) {
                    // 使用 Naive UI 訊息系統
                    try {
                        msgInstance.success({
                            content: `${successTitle} ID: ${data.id}`,
                            duration: 3000,
                            closable: true
                        });
                    } catch (e) {
                        console.error('Naive UI 訊息顯示失敗:', e);
                    }

                    // 使用瀏覽器內建 alert 作為備用
                    alert(`${successTitle}\n\n${successContent}`);

                    // 詢問用戶後續動作
                    const confirmed = confirm('是否返回活動列表？');
                    if (confirmed) {
                        window.location.href = redirectUrl;
                    } else {
                        resetForm();
                    }
                } else {
                    // 錯誤訊息
                    try {
                        msgInstance.error(data.message || '操作失敗');
                    } catch (e) {
                        alert(`操作失敗: ${data.message || '未知錯誤'}`);
                    }
                }
            };

            // 提交表單處理
            const handleSubmit = async (e) => {
                e.preventDefault();
                try {
                    // 表單驗證
                    await formRef.value?.validate();

                    // 必要欄位檢查
                    const requiredFields = ['activity_name', 'description', 'location', 'start_date', 'end_date'];

                    // 創建 FormData 用於提交
                    const formData = new FormData();

                    // 生成 UUID
                    const generatedUUID = generateUUID();
                    console.log("生成的UUID:", generatedUUID);

                    // 準備要發送的數據
                    const submitData = {
                        uid: generatedUUID,
                        activity_name: formValue.value.activity_name,
                        description: formValue.value.description,
                        organizer: formValue.value.organizer || '',
                        address: formValue.value.address || '',
                        location: formValue.value.location,
                        start_date: formatDate(formValue.value.date_range?.[0]),
                        end_date: formatDate(formValue.value.date_range?.[1]),
                        latitude: null,
                        longitude: null,
                        ticket_price: formValue.value.ticket_price || '',
                        source_url: formValue.value.source_url || '',
                        image_url: ''
                    };

                    // 驗證必填欄位
                    for (const field of requiredFields) {
                        if (!submitData[field]) {
                            throw new Error(`${field} 是必填欄位`);
                        }
                    }

                    // 設置 UID
                    formData.append('uid', generatedUUID);

                    // 將其他數據添加到 FormData
                    Object.keys(submitData).forEach(key => {
                        if (key !== 'uid') {
                            formData.append(key, submitData[key]);
                        }
                    });

                    // 如果有圖片檔案，添加到 FormData
                    if (formValue.value.imageFile) {
                        formData.append('image', formValue.value.imageFile);
                    }

                    // 獲取 CSRF 令牌
                    const csrfToken = getCsrfToken();

                    // 發送 API 請求
                    try {
                        const response = await axios.post(
                            '/admin-dashboard/entertainment/activities/create/',
                            formData,
                            {
                                headers: {
                                    'X-CSRFToken': csrfToken,
                                    'Content-Type': 'multipart/form-data'
                                }
                            }
                        );

                        console.log('Response:', response.data);

                        if (response.data.status === 'success') {
                            // 顯示更明顯的成功訊息
                            console.log('活動建立成功，活動ID:', response.data.id);
                            console.log('活動建立時間:', response.data.created_at);

                            // 顯示成功訊息並處理後續動作
                            showResultMessage(true, response.data);
                        } else {
                            throw new Error(response.data.message || '建立活動失敗');
                        }
                    } catch (error) {
                        console.error('API Error:', error.response?.data || error);
                        showResultMessage(false, {
                            message: error.response?.data?.message || error.message || '建立活動失敗'
                        });
                    }
                } catch (error) {
                    console.error('Form Error:', error);
                    showResultMessage(false, { message: error.message || '表單驗證失敗' });
                }
            };

            // 重置表單
            const resetForm = () => {
                formValue.value = {
                    activity_name: '',
                    description: '',
                    location: '',
                    address: '',
                    organizer: '',
                    source_url: '',
                    date_range: null,
                    start_time: null,
                    end_time: null,
                    ticket_price: '',
                    activity_type: null,
                    image: null,
                    imageFile: null
                };
                formRef.value?.restoreValidation();
            };

            return {
                formRef,
                formValue,
                activityTypes,
                rules,
                handleSubmit,
                initMessageSystem,
                handleBack,
                resetForm,
                handleImageUpload,
                showImagePreview,
                initComponent
            };
        },
        template: `
        <n-message-provider>
            <n-layout class="p-6" @mounted="initComponent">
                <n-card class="mb-6">
                    <n-grid :cols="2">
                        <n-grid-item>
                            <h1 class="text-2xl font-bold mb-2">{{ page_title }}</h1>
                            <p class="text-gray-600">{{ page_description }}</p>
                        </n-grid-item>
                        <n-grid-item class="text-right">
                            <n-button type="default" @click="handleBack">
                                <template #icon>&#8592;</template>
                                返回列表
                            </n-button>
                        </n-grid-item>
                    </n-grid>
                </n-card>

                <n-grid :x-gap="12" :cols="2">
                    <n-grid-item span="1">
                        <n-card title="活動基本資訊" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="活動名稱" path="activity_name">
                                    <n-input
                                        v-model:value="formValue.activity_name"
                                        placeholder="請輸入活動名稱（最多30字）"
                                        :maxlength="30"
                                        show-count
                                    />
                                </n-form-item>

                                <n-form-item label="主辦單位" path="organizer">
                                    <n-input
                                        v-model:value="formValue.organizer"
                                        placeholder="請輸入主辦單位名稱"
                                    />
                                </n-form-item>

                                <n-form-item label="請輸入活動介紹" path="description">
                                    <n-input
                                        v-model:value="formValue.description"
                                        type="textarea"
                                        placeholder="請輸入活動介紹（最多500字）"
                                        :rows="4"
                                        :maxlength="500"
                                        show-count
                                        :autosize="{ minRows: 4, maxRows: 8 }"
                                    />
                                </n-form-item>

                                <n-form-item label="活動地點" path="location">
                                    <n-input v-model:value="formValue.location" placeholder="請輸入活動地點"/>
                                </n-form-item>

                                <n-form-item label="活動詳細地址" path="address">
                                    <n-input v-model:value="formValue.address" placeholder="請輸入活動詳細地址"/>
                                </n-form-item>

                                <n-grid :cols="2" :x-gap="12">
                                    <n-grid-item>
                                        <n-form-item label="活動日期" path="date_range">
                                            <div style="max-width: 300px;">
                                                <n-date-picker
                                                    v-model:value="formValue.date_range"
                                                    type="daterange"
                                                    clearable
                                                    :disabled-date="(ts) => ts < Date.now() - 24 * 60 * 60 * 1000"
                                                    start-placeholder="開始日期"
                                                    end-placeholder="結束日期"
                                                    :default-time="['00:00:00', '23:59:59']"
                                                    style="width: 100%;"
                                                />
                                            </div>
                                        </n-form-item>
                                    </n-grid-item>
                                    <n-grid-item>
                                        <n-grid :cols="2" :x-gap="8">
                                            <n-grid-item>
                                                <n-form-item label="活動起始時間" path="start_time">
                                                    <n-time-picker
                                                        v-model:value="formValue.start_time"
                                                        clearable
                                                        format="HH:mm"
                                                        :minutes-step="5"
                                                        :minutes-options="[
                                                            '00', '05', '10', '15', '20', '25',
                                                            '30', '35', '40', '45', '50', '55'
                                                        ]"
                                                        :use-12-hours="false"
                                                        placement="top-start"
                                                        :is-hours-disabled="(hour) => false"
                                                        :is-minutes-disabled="(minute) => minute % 5 !== 0"
                                                        :actions="null"
                                                        style="width: 100%;"
                                                    />
                                                </n-form-item>
                                            </n-grid-item>
                                            <n-grid-item>
                                                <n-form-item label="活動結束時間" path="end_time">
                                                    <n-time-picker
                                                        v-model:value="formValue.end_time"
                                                        clearable
                                                        format="HH:mm"
                                                        :minutes-step="5"
                                                        :minutes-options="[
                                                            '00', '05', '10', '15', '20', '25',
                                                            '30', '35', '40', '45', '50', '55'
                                                        ]"
                                                        :use-12-hours="false"
                                                        placement="top-start"
                                                        :is-hours-disabled="(hour) => false"
                                                        :is-minutes-disabled="(minute) => minute % 5 !== 0"
                                                        :actions="null"
                                                        style="width: 100%;"
                                                    />
                                                </n-form-item>
                                            </n-grid-item>
                                        </n-grid>
                                    </n-grid-item>
                                </n-grid>
                            </n-form>
                        </n-card>
                    </n-grid-item>

                    <n-grid-item span="1">
                        <n-card title="活動詳細設定" class="mb-6">
                            <n-form ref="formRef" :model="formValue" :rules="rules">
                                <n-form-item label="票價資訊">
                                    <n-input v-model:value="formValue.ticket_price" placeholder="請輸入票價資訊（若為免費活動可不填）"/>
                                </n-form-item>

                                <n-form-item label="活動類型" path="activity_type">
                                    <n-select
                                        v-model:value="formValue.activity_type"
                                        :options="activityTypes"
                                        placeholder="請選擇活動類型"
                                    />
                                </n-form-item>

                                <n-form-item label="活動網址" path="source_url">
                                    <n-input v-model:value="formValue.source_url" placeholder="請輸入活動官方網址"/>
                                </n-form-item>

                                <n-form-item label="活動圖片">
                                    <n-upload
                                        accept="image/*"
                                        :max="1"
                                        @change="handleImageUpload"
                                        list-type="image-card"
                                    >
                                        <n-button>上傳圖片</n-button>
                                    </n-upload>
                                    <p class="text-sm text-gray-500 mt-2">建議尺寸: 1200x630 像素，檔案大小不超過 2MB，圖片將保存在服務器上</p>
                                </n-form-item>

                                <!-- 圖片預覽區域 -->
                                <div v-if="formValue.image" class="mb-6 mt-2 border-t pt-4 border-gray-200">
                                    <h3 class="text-lg font-medium text-gray-700 mb-3">圖片預覽</h3>
                                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                                        <p class="text-xs text-gray-500 text-left mt-2">上傳的圖片將顯示在活動詳情頁面</p>
                                        <img :src="formValue.image" class="mx-auto" style="max-width: 100%; max-height: 300px; object-fit: contain;" />
                                    </div>
                                </div>

                                <div class="flex justify-between mt-6 space-x-12">
                                    <n-button type="primary" @click="handleSubmit" size="large">
                                        <template #icon>💾</template>
                                        建立活動
                                    </n-button>
                                    <n-button type="error" @click="resetForm" size="large">
                                        <template #icon>🔄</template>
                                        重置
                                    </n-button>
                                </div>
                            </n-form>
                        </n-card>
                    </n-grid-item>
                </n-grid>
            </n-layout>
        </n-message-provider>
    `
    });

    app.mount('#app');
</script>
{% endblock %}