# TravelFun 主題育樂功能技術文件

## 1. 整體架構

TravelFun 是一個採用前後端分離架構的旅遊娛樂平台，主題育樂功能是其中重要的模組之一。

### 系統架構

- **前後端分離**：採用 Vue + Vite 前端與 Django 後端分離的架構
- **資料夾結構**：
  - 前端：專案根目錄（除了 DjangoAdmin2 資料夾外）
  - 後端：`DjangoAdmin2` 資料夾（其中 `theme_entertainment` 為主題育樂模組）

### 資料流向

- 前端通過 RESTful API 向後端請求資料
- 後端從多個外部 API 源收集活動資料並進行標準化處理
- 處理後的資料存儲在資料庫中，並通過 API 提供給前端使用

### 程式碼組織

- **後端模組化**：每個功能區塊都有獨立的應用模組
- **前端元件化**：使用 Vue 元件系統組織 UI 界面
- **API 層**：統一的 API 設計和封裝
- **資料模型**：清晰的資料結構定義

### 部署架構

- 開發環境：使用 Vite 開發伺服器 + Django 開發伺服器
- 生產環境：支援容器化部署
- 前後端通信：使用 HTTP/HTTPS 協議，支援跨域設置

## 2. 前端開發工具

### 核心框架與平台

- **Vue 3**：採用 Vue 3 框架作為前端核心
- **Vite**：使用 Vite 作為開發與構建工具
- **TypeScript**：採用 TypeScript 進行開發，提供類型安全

### UI 組件與樣式

- **Naive UI**：使用 Naive UI 組件庫提供卡片、分頁、按鈕等元件
- **Tailwind CSS**：採用 Tailwind CSS 實現響應式設計
- **自定義元件**：針對特定業務需求開發自定義元件

### 開發環境工具

- **ESLint**：程式碼風格檢查
- **Prettier**：程式碼格式化工具
- **PostCSS**：CSS 後處理器
- **TypeScript Compiler**：TypeScript 編譯工具

### 包管理與構建工具

- **npm/pnpm**：依賴包管理
- **Vite 構建配置**：自定義的 Vite 構建配置
- **環境變數管理**：使用 `.env` 檔案管理環境變數

### 版本控制與協作

- **Git**：版本控制系統
- **文件結構規範**：統一的專案文件結構

## 3. 前端開發技術

### 核心技術

- **Vue 3 Composition API**：使用組合式 API 進行狀態管理和邏輯組織
- **Vue Router**：實現單頁應用的路由管理
- **TypeScript**：提供靜態類型檢查，增強代碼可維護性
- **響應式設計**：使用 Tailwind CSS 的響應式類實現多設備適配

### 狀態管理與數據處理

- **Pinia**：使用 Pinia 進行全局狀態管理
- **Axios**：處理 HTTP 請求，與後端 API 交互
- **資料轉換與格式化**：處理不同來源和格式的資料
- **本地存儲**：使用 `localStorage` 保存用戶偏好設置

### 用戶界面與體驗

- **元件化設計**：將 UI 拆分為可重用的元件
- **自定義指令**：開發自定義指令增強交互體驗
- **動畫與過渡效果**：使用 Vue Transition 和 CSS 動畫
- **錯誤處理與提示**：友好的錯誤提示和處理機制

### 性能優化

- **懶加載**：路由和大型元件使用懶加載技術
- **虛擬列表**：處理大量數據顯示時的性能優化
- **圖片優化**：圖片懶加載和優化處理
- **代碼分割**：將代碼按需分割，減少初始加載時間

### 開發模式與最佳實踐

- **SOLID 原則**：遵循 SOLID 設計原則進行開發
- **元件設計模式**：採用最佳的元件設計模式
- **代碼審查與質量控制**：嚴格的代碼審查流程
- **測試與驗證**：單元測試和集成測試

## 4. 後端開發工具

### 核心框架

- **Django**：使用 Django 框架作為後端核心
- **Django REST Framework**：提供 RESTful API 支援
- **SQLite**：開發環境使用的資料庫

### API 與身份驗證

- **Django REST Framework**：構建 RESTful API
- **JWT (JSON Web Token)**：實現基於令牌的身份驗證
- **CORS 中間件**：處理跨域資源共享

### 資料處理與整合

- **Django ORM**：資料庫對象關係映射
- **資料轉換工具**：自定義的資料轉換和處理工具
- **API 客戶端**：與外部服務 API 交互的客戶端工具

### 開發與調試工具

- **Django Debug Toolbar**：開發調試工具
- **Django Extensions**：擴展 Django 功能的工具
- **日誌系統**：記錄系統運行情況和錯誤

### 部署與運行環境

- **WSGI/ASGI**：Web 服務器網關介面
- **靜態文件處理**：Django 靜態文件管理
- **環境配置管理**：開發和生產環境配置管理

## 5. 後端開發技術

### 核心技術

- **MVC 架構**：使用 Django 的模型-視圖-控制器模式
- **RESTful API 設計**：遵循 REST 原則設計 API
- **ORM 技術**：使用 Django ORM 進行資料庫操作
- **中間件**：使用 Django 中間件處理請求和響應

### 資料模型與資料庫操作

- **Django 模型**：使用 Django 模型定義資料結構
- **資料庫遷移**：使用 Django 遷移系統管理資料庫結構
- **查詢優化**：優化資料庫查詢提升性能
- **原生 SQL**：在必要時使用原生 SQL 提升性能

### API 實現與安全性

- **序列化器**：使用 DRF 序列化器處理資料轉換
- **視圖集和路由**：使用 DRF 視圖集和路由器
- **權限控制**：實現細粒度的權限控制
- **輸入驗證與清理**：驗證和清理用戶輸入

### 外部 API 整合與資料同步

- **API 封裝**：封裝外部 API 調用
- **資料標準化**：標準化不同來源的資料格式
- **自動同步機制**：定期自動同步外部資料
- **錯誤處理與恢復**：處理外部 API 調用的錯誤與恢復

### 性能與可擴展性

- **資料庫索引**：優化資料庫索引提升查詢性能
- **緩存策略**：使用緩存減少資料庫訪問
- **異步任務處理**：處理長時間運行的任務
- **資料分頁**：實現大量數據的分頁返回

## 6. 重點功能

### 活動資料管理

- **統一資料模型**：設計統一的活動資料模型
- **多源資料整合**：整合台北、新北、文化部、台北藝術博物館等多個資料來源
- **資料標準化處理**：處理不同來源的資料格式差異
- **資料質量控制**：清理和驗證外部資料的完整性和準確性

### 活動查詢與展示

- **多維度搜尋**：支援關鍵字、日期、狀態等多種搜尋條件
- **智慧分類**：自動將活動分為「即將結束」、「進行中」等狀態
- **活動詳情頁**：展示活動的詳細資訊
- **地理位置支援**：顯示活動地點和地圖信息

### 用戶界面優化

- **響應式設計**：適配不同設備大小的界面
- **圖片輪播**：支援活動多圖片展示和輪播
- **分頁瀏覽**：實現大量活動的分頁瀏覽
- **狀態視覺化**：使用不同顏色和標籤表示活動狀態

### 搜尋和個性化

- **搜尋建議**：提供智慧搜尋建議
- **搜尋歷史**：記錄用戶搜尋歷史
- **用戶偏好**：記住用戶的分頁大小等偏好設置
- **自定義過濾**：允許用戶自定義活動過濾條件

### 管理功能

- **後台活動管理**：新增、編輯、刪除活動
- **活動狀態監控**：監控活動狀態和時間
- **資料更新控制**：控制外部資料的更新頻率和方式
- **統計與分析**：提供活動數據的統計與分析功能

## 7. 詳細技術實現：多源資料整合

主題育樂模組的核心優勢之一是能夠從多個官方資料來源獲取活動資訊，並將其整合到統一的資料模型中。此功能實現了跨平台活動資訊的統一存取與展示。

### 7.1 資料來源

系統整合了以下主要資料來源：

1. **文化部展演資訊 API**

   - 提供全國藝文展演資訊
   - 包含展覽、表演、講座等多種活動類型
   - 資料來源：文化部開放資料平台

2. **台北市政府活動資訊**

   - 台北市舉辦的各類文化與休閒活動
   - 資料來源：台北市開放資料平台

3. **新北市政府活動資訊**

   - 新北市舉辦的各類文化與休閒活動
   - 資料來源：新北市開放資料平台

4. **台北市立美術館展覽資訊**

   - 專門收集台北市立美術館的展覽與活動
   - 資料來源：台北市立美術館開放 API

5. **其他可擴展資料來源**
   - 系統設計支援輕鬆添加新的資料來源

### 7.2 資料整合流程

資料整合的完整流程如下：

1. **資料獲取**

   - 各 API 模組封裝（culture_api.py, taipei_api.py, newtaipei_api.py, tfam_api.py）
   - 實現錯誤重試機制與請求限流
   - 處理各種 API 響應格式（JSON, XML, CSV 等）

2. **資料預處理與標準化**

   - 統一日期時間格式（使用 convert_date_format 函數）
   - 標準化地點和地址信息
   - 處理並規範化圖片 URL 格式
   - 驗證經緯度數據合法性

3. **資料清洗與篩選**

   - 過濾無效或不完整資料
   - 排除重複活動（基於 UID 或活動名稱與日期的組合）
   - 處理特殊字符和編碼問題
   - 資料優先級處理（相同活動來自不同來源時的選擇策略）

4. **資料轉換與增強**

   - 將各來源資料映射到統一的 `Events` 模型
   - 處理缺失欄位（如果某來源沒有提供特定欄位）
   - 使用地理編碼服務補充缺失的經緯度信息
   - 豐富資料（如分類標籤、相關活動推薦等）

5. **資料持久化**
   - 生成 JSON 格式資料快照（用於前端快速讀取）
   - 生成 SQL 指令（用於資料庫導入）
   - 增量更新策略（避免覆蓋使用者手動編輯的資料）

### 7.3 資料更新機制

系統實現了多種更新策略：

- **手動觸發更新**：管理員可在後台手動觸發資料更新
- **定時自動更新**：系統會定期自動從各資料源獲取最新活動
- **增量更新**：只更新新增或變更的活動，保留現有資料
- **完全更新**：完全重新獲取所有資料源的資料

### 7.4 技術實現重點

- **模組化設計**：每個資料源都有獨立的 API 模組，易於維護和擴展
- **統一介面**：所有資料源模組實現了統一的介面，便於系統集成
- **錯誤處理**：完善的錯誤處理機制，確保單一資料源問題不影響整體功能
- **資料版本控制**：記錄每次資料更新的版本和時間，支援回滾操作
- **效能優化**：實現並行獲取和處理資料，提高更新效率

### 7.5 實現挑戰與解決方案

1. **資料格式差異**

   - 挑戰：不同來源的資料格式、欄位名稱和內容結構各不相同
   - 解決方案：建立彈性的映射層，將不同來源的資料結構映射到統一模型

2. **日期時間格式**

   - 挑戰：各平台使用不同的日期時間格式
   - 解決方案：使用靈活的日期解析函數（convert_date_format），支援多種格式

3. **圖片 URL 處理**

   - 挑戰：各平台提供的圖片 URL 格式不一致
   - 解決方案：統一處理圖片 URL，支援單一 URL 和多圖片列表

4. **資料完整性**

   - 挑戰：部分來源提供的資料不完整
   - 解決方案：實現資料補全策略，並在顯示時適當處理缺失資料

5. **資料重複**
   - 挑戰：不同來源可能包含相同活動
   - 解決方案：實現基於活動名稱、日期和地點的去重算法

## 8. 詳細技術實現：智慧分類

主題育樂模組實現了智慧活動分類系統，能夠根據活動的時間特性自動將活動分類，為用戶提供更有價值的瀏覽體驗。

### 8.1 分類架構

系統實現了以下七種主要分類：

1. **只限今日（Today Only）**

   - 定義：僅在當天進行、當天結束的活動
   - 目的：突出顯示用戶可以立即參與且即將錯過的活動
   - 優先級：最高（在列表中最先顯示）

2. **即將結束（Ending Soon）**

   - 定義：將在三天內結束的活動
   - 目的：提醒用戶把握最後機會參與這些活動
   - 優先級：次高（在列表中第二位置顯示）

3. **進行中（Ongoing）**

   - 定義：已經開始且持續時間超過三天的活動
   - 目的：展示目前正在進行中的長期活動
   - 優先級：中（在列表中第三位置顯示）

4. **即將開始（Upcoming）**

   - 定義：將在三天內開始的活動
   - 目的：讓用戶提前知道並計劃參與即將開始的活動
   - 優先級：中低（在列表中第四位置顯示）

5. **未開始（Not Started）**

   - 定義：將在三天後開始的活動
   - 目的：提供未來活動的預覽
   - 優先級：低（在列表中第五位置顯示）

6. **已結束（Ended）**

   - 定義：已經結束的活動
   - 目的：提供歷史活動記錄
   - 優先級：次低（在列表中第六位置顯示）

7. **未知（Unknown）**
   - 定義：時間資訊不完整或無法解析的活動
   - 目的：確保所有活動都能被分類和顯示
   - 優先級：最低（在列表中最後顯示）

### 8.2 分類算法

分類算法的核心實現在 `sortActivities` 函數中：

1. **時間差計算**

   - 計算活動開始時間與當前時間的差值（startDiff）
   - 計算活動結束時間與當前時間的差值（endDiff）
   - 判斷活動開始和結束是否在同一天（isSameDay）

2. **分類邏輯**

   - 依次判斷活動符合哪一類別的條件
   - 使用優先順序判斷，確保每個活動只會被分到一個類別
   - 對於日期資訊不完整或格式不正確的活動，歸類為「未知」

3. **子類別排序**
   - 在每個主分類內部，根據特定規則進行二次排序
   - 「只限今日」和「即將結束」：按開始時間升序排列
   - 「進行中」：按開始時間降序排列（最近開始的先顯示）
   - 「即將開始」和「未開始」：按開始時間升序排列
   - 「已結束」：按結束時間降序排列（最近結束的先顯示）
   - 「未知」：按活動名稱字母順序排列

### 8.3 分類顯示與視覺化

每個分類使用不同的視覺效果加以區分：

1. **狀態標籤**

   - 每個活動卡片顯示其所屬分類的標籤
   - 使用不同顏色區分不同狀態：
     - 只限今日：紅色
     - 即將結束：橙色
     - 進行中：綠色
     - 即將開始：黃色
     - 未開始：深灰色
     - 已結束：淺灰色
     - 未知：紫色

2. **動畫效果**

   - 「只限今日」：使用快速脈動動畫提高注意力
   - 「即將結束」：使用柔和脈動動畫

3. **過濾功能**
   - 用戶可以根據活動狀態進行過濾
   - 支援多狀態組合過濾

### 8.4 技術實現重點

- **時間處理**：使用 JavaScript 的 Date 對象處理時間計算
- **響應式更新**：當前時間變化時，活動分類會自動更新
- **分類緩存**：計算結果會被缓存，避免重複計算
- **使用 TypeScript 類型**：使用 CategorizedActivities 介面確保類型安全

### 8.5 實現挑戰與解決方案

1. **時區處理**

   - 挑戰：不同來源的活動可能使用不同的時區
   - 解決方案：標準化所有時間為本地時區，確保分類的準確性

2. **日期格式解析**

   - 挑戰：處理各種格式的日期字串
   - 解決方案：實現強大的日期解析邏輯，能夠處理多種日期格式

3. **動態分類**

   - 挑戰：隨時間變化，活動的分類狀態也需要變化
   - 解決方案：在用戶查看列表時即時計算分類，確保狀態最新

4. **效能優化**

   - 挑戰：處理大量活動數據時的性能問題
   - 解決方案：實現分頁載入和虛擬滾動，減少同時處理的活動數量

5. **視覺一致性**
   - 挑戰：確保各種狀態下的視覺效果一致且易於理解
   - 解決方案：使用一致的顏色編碼系統和視覺階層

DjangoAdmin2/
└── theme_entertainment/
├── models.py # 資料模型定義
├── views.py # API 視圖邏輯
├── serializers.py # 資料序列化
├── urls.py # URL 路由設定
├── culture_api.py # 文化部 API 介接
├── taipei_api.py # 台北市 API 介接
├── newtaipei_api.py # 新北市 API 介接
├── tfam_api.py # 台北藝術博物館 API 介接
├── main.py # 主要整合邏輯
└── json_to_sql.py # 資料轉換工具

src/
├── views/
│ └── front/
│ └── Events/ # 活動相關視圖
├── components/
│ └── events/ # 活動相關元件
└── api/
└── events.ts # 活動 API 呼叫
